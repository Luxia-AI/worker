name: RAG Worker CI

on:
    push:
        branches: [main, dev]
    pull_request:
        branches: [main, dev]

jobs:
    test-and-quality:
        runs-on: ubuntu-latest
        environment: Actions

        # Ensures vars are loaded BEFORE Python imports settings
        env:
            CI: "true"
            PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
            PINECONE_INDEX_NAME: ${{ vars.PINECONE_INDEX_NAME }}
            GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
            GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
            GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
            NEO4J_URI: ${{ secrets.NEO4J_URI }}
            NEO4J_USER: ${{ secrets.NEO4J_USER }}
            NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}

        steps:
            - name: Checkout Repo
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"
                  cache-dependency-path: |
                      requirements.txt
                      requirements-dev.txt

            - name: Cache Playwright Browsers
              uses: actions/cache@v4
              with:
                  path: ~/.cache/ms-playwright
                  key: playwright-${{ runner.os }}-${{ hashFiles('**/requirements-dev.txt') }}
                  restore-keys: |
                      playwright-${{ runner.os }}-

            - name: Clean pip cache if needed
              run: pip cache purge --verbose || true

            - name: Install Dependencies
              run: |
                  pip install --upgrade pip
                  pip install --no-cache-dir -r requirements-dev.txt

            # ===================
            #     TESTING
            # ===================
            - name: Run Unit Tests (skip Redis/E2E tests in CI)
              run: pytest -q --disable-warnings -m "not redis_required and not e2e" --ignore=test_load.py

            # ===================
            #     LINTING
            # ===================
            - name: Ruff Linter
              run: ruff check .

            - name: Black (check mode)
              run: black --check app tests

            - name: isort (check)
              run: isort --check-only app tests

            - name: Flake8
              run: flake8 app tests

            # ===================
            #   SECURITY & TYPES
            # ===================
            - name: Bandit Security Scan
              run: bandit -r app

            - name: mypy (type checking)
              run: mypy app

            # ===================
            #   CLEANUP
            # ===================
            - name: Clean up cache and temp files
              if: always()
              run: |
                  rm -rf ~/.cache/ms-playwright
