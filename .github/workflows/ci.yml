name: RAG Worker CI

on:
    push:
        branches: [main, dev]
    pull_request:
        branches: [main, dev]

jobs:
    test-and-quality:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Repo
              uses: actions/checkout@v3

            - name: Create .env file for CI
              run: |
                  cat > .env << EOF
                  PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}
                  PINECONE_INDEX_NAME=${{ vars.PINECONE_INDEX_NAME }}
                  GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
                  GOOGLE_CSE_ID=${{ secrets.GOOGLE_CSE_ID }}
                  GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
                  EOF

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install Dependencies
              run: |
                  pip install -r requirements-dev.txt

            - name: Install Playwright Browsers
              run: |
                  playwright install chromium

            - name: Install Groq SDK manually
              run: |
                  pip install groq

            - name: Run Unit Tests
              run: pytest -v

            - name: Run Ruff Linter
              run: ruff check .

            - name: Run Black (check mode)
              run: black --check app tests

            - name: Run isort (check mode)
              run: isort --check-only app tests

            - name: Run Flake8
              run: flake8 app tests

            - name: Run Bandit (security scan)
              run: bandit -r app

            - name: Run mypy (type checking)
              run: mypy app
